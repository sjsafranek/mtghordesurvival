<html>
    <head><meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Mtg Deck Builder</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
        <!-- <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css"> -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />

        <style>

            .mtgcard {
                margin: 1px;
                border: 4px solid #ffffff;
                border-radius: 8px;
                transition: border-color 0.3s linear;
            }

            .mtgcard.selected {
                border-color: #0088cc !important;
            }

        </style>

    </head>
    <body>

        <main role="main" class="container">

            This project uses the ScryFall api (https://scryfall.com/docs/api)

            <div class="row">
                <div class="col-md-12">
                    <h4 class="mt-5">Horde Survival</h4>
                    <button id="addZombie" class="btn btn-sm btn-danger ml-2" title="Add Zombie">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="takeTurn" class="btn btn-sm btn-primary ml-2" title="Take Turn">
                        <i class="fas fa-forward"></i>
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    <label>Hand: </label><span class="hand"></span>
                </div>
                <div class="col-md-3">
                    <label>Library: </label><span class="library"></span>
                </div>
                <div class="col-md-3">
                    <label>Graveyard: </label><span class="graveyard"></span>
                </div>
                <div class="col-md-3">
                    <label>Exile: </label><span class="exile"></span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 battlefield">
                </div>
            </div>

            <div id="card_container"></div>

        </main>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.2/d3.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <!-- <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script> -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
        <script src="https://kit.fontawesome.com/131ba7f97d.js"></script>

        <script src="https://underscorejs.org/underscore-min.js"></script>
        <script src="https://backbonejs.org/backbone-min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.0/backbone.localStorage-min.js" type="text/javascript">

        <script type="text/template" id="card_template">
            <div class="card">
                <img></img>
            </div>
        </script>

        <script>


var zombie;



var Card = Backbone.Model.extend({
    // Override for scryfall 'id' field.
    // Backbone will use this attribute to make models singletons.
    idAttribute: "_id",
    defaults: {},
    initialize: function(){},
    getName: function() {
        return this.get('name');
    },
    getTypes: function() {
        return this.get('type_line');
    },
    isType: function(cardType) {
        return -1 != this.getTypes()
                        .toLowerCase()
                        .indexOf(cardType.toLowerCase());
    },
    isPermanent: function() {
        const cardTypes = [
            'Artifact',
            'Creature',
            'Enchantment',
            'Land',
            'Planeswalker'
        ];
        for (var i=0; i<cardTypes.length; i++) {
            if (this.isType(cardTypes[i])) {
                return true;
            }
        }
        return false;
    },
    getImage: function(size) {
        return this.get('image_uris')[size||'small'];
    }
});


var Zone = Backbone.Collection.extend({
    model: Card,
    localStorage: new Store("mtghordesurvival"),
    chooseRandom: function() {
        var idx = Math.round(Math.random() * this.length);
        return this.models[idx];
    }
});


var CardView = Backbone.View.extend({
    initialize: function(){
        this.render();
    },
    render: function(){
        // Compile the template using underscore
        var template = _.template( $("#card_template").html(), {} );
        // Load the compiled HTML into the Backbone "el"
        this.$el.html( template );
        this.$el.find('img').attr('src', this.model.getImage());
    }
});

// var cardView = new CardView({ model: new Card({name:'SPAM'}), el: $("#card_container") });





toastr.options = {
    "closeButton": true,
    "newestOnTop": true,
    "timeOut": 2000
};




var Player = function() {
    var self = this;

    this.zones = {
        exile: new Zone(),
        graveyard: new Zone(),
        library: new Zone(),
        hand: new Zone(),
        battlefield: new Zone(),
        stack: new Zone(),
        command: new Zone()
    }

    this._callbacks = {
        "Grave Titan": function() {
            // etb create two tokens
            self.resolveSpell(zombie);
            self.resolveSpell(zombie);
        },
        "Damnation": function() {
            // destroy all creatures
            self.boardWipe('graveyard', 'Creature');
        },
        "Army of the Damned": function() {
            // create 13 zombies
            for (var i=0; i<13; i++) {
                self.resolveSpell(zombie);
            }

            // has flashback
            if (self.zones.graveyard.length && 'Army of the Damned' == self.zones.graveyard[self.zones.graveyard.length-1].name) {
                var card = self.zones.graveyard.pop();
                self.castSpell(card, function(){
                    if (self.zones.graveyard.length && 'Army of the Damned' == self.zones.graveyard[self.zones.graveyard.length-1].name) {
                        var card = self.zones.graveyard.pop();
                        self.zones.exile.push(card);
                    }
                });
            }
            //.end
        },
        "Twilight's Call": function() {
            // all creatures from graveyard to battlefield
            var noncreatures = [];
            while(self.zones.graveyard.length) {
                var card = self.zones.graveyard.shift();
                if (card.isType('Creature')) {
                    self.resolveSpell(card);
                } else {
                    noncreatures.push(card);
                }
            }

            // put noncreatures spells back into graveyard
            while(noncreatures.length) {
                var card = noncreatures.shift();
                self.zones.graveyard.push(card);
            }
        }
    }

    this.updateCounts();
}

Player.prototype.updateCounts = function() {
    $('.hand').text(this.zones.hand.length);
    $('.library').text(this.zones.library.length);
    $('.graveyard').text(this.zones.graveyard.length);
    $('.exile').text(this.zones.exile.length);
}

Player.prototype.takeTurn = function() {
    if (!this.zones.library.length) {
        $('#draw').addClass('disabled');
        return;
    }

    var card = this.drawCard();
    while(-1 != ['Zombie', 'Zombie Giant'].indexOf(card.getName())) {
        card = this.drawCard();
    }

    this.castSpells();
}

Player.prototype.drawCard = function() {
    if (!this.zones.library.length) {
        toastr.warning("No cards in library!");
        return;
    }
    toastr.success("Draw a card");
    var card = this.zones.library.chooseRandom();
    this.zones.library.remove(card);
    this.zones.hand.add(card);
    this.updateCounts();
    return card;
}

Player.prototype.castSpells = function() {
    var self = this;
    // cast all spells from hand
    if (this.zones.hand.length) {
        var card = this.zones.hand.shift();
        this.castSpell(card, function() {
            self.castSpells();
        });
    }

    this.updateCounts();
}

Player.prototype.castSpell = function(card, callback) {
    var self = this;

    toastr.info("Cast " + card.getName());

    Swal.fire({
        title: card.getName(),
        imageUrl: card.getImage('normal'),
        showCancelButton: true,
        focusConfirm: false,
        confirmButtonText: 'Resolve',
        cancelButtonText: 'Cancel',
        animation: false
    }).then(function(result){
        if (!result.value) {
            self.zones.graveyard.push(card);
            callback && callback();
            return;
        }

        self.resolveSpell(card, callback);
    });
}

Player.prototype.boardWipe = function(zone, cardType) {
    $('.mtgcard').trigger('change_zone', {zone: zone || 'graveyard', cardType: cardType});
}

Player.prototype.resolveSpell = function(card, callback) {
    var self = this;

    toastr.success(card.getName() + " resolved");

    if (card.isPermanent()) {
        this.zones.battlefield.add(card);
        $('.battlefield').append(
            $('<img>', {src: card.getImage()})
                .addClass('mtgcard')
                .on('contextmenu', function(e) {
                    e.preventDefault();
                    Swal.fire({
                        title: 'Select zone',
                        input: 'select',
                        inputOptions: {
                            exile: 'exile',
                            graveyard: 'graveyard',
                            library: 'library',
                            hand: 'hand'
                        },
                        inputPlaceholder: 'Select a zone',
                        showCancelButton: true
                    }).then(function(result) {
                        var zone = result.value;
                        if (zone) {
                            var $elems = $('.mtgcard.selected');
                            if ($elems.length) {
                                $elems.trigger('change_zone', {zone: zone});
                                return;
                            }

                            $(e.target).remove();
                            self.zones.battlefield.remove(card)
                            self.zones[zone].add(card);
                        }
                    });
                }).on('click', function(e){
                    $(e.target).toggleClass('selected');
                }).on('change_zone', function(e, args){
                    if (args.cardType && !card.isType(args.cardType)) {
                        return;
                    }
                    toastr.info(card.getName() + " was put into " + args.zone + " from the battlefield.");
                    self.zones.battlefield.remove(card);
                    self.zones[args.zone].add(card);
                    $(this).remove();
                    self.updateCounts();
                })
        );
    } else {
        this.zones.graveyard.add(card);
    }

    callback && callback();

    this._callbacks[card.getName()] && this._callbacks[card.getName()]();
}




// Build deck
var data = 'count,name\n1,Call to the Grave\n2,Bad Moon\n1,Plague Wind\n1,Damnation\n1,Yixlid Jailer\n1,Forsaken Wastes\n2,Nested Ghoul\n2,Infectious Horror\n2,Delirium Skeins\n1,Blind Creeper\n2,Soulless One\n2,Vengeful Dead\n1,Fleshbag Marauder\n1,Carrion Wurm\n3,Maggot Carrier\n4,Cackling Fiend\n1,Death Baron\n1,Grave Titan\n2,Severed Legion\n1,Skulking Knight\n1,Undead Warchief\n1,Twilights Call\n1,Army of the Damned\n1,Endless Ranks of the Dead\n2,Rotting Fensnake\n1,Unbreathing Horde\n1,Walking Corpse\n5,Zombie Giant\n55,Zombie';

function fetchCard(card_name, callback) {
    $.ajax({
        method: 'GET',
        url: 'https://api.scryfall.com/cards/named?exact=' + card_name,
    }).done(callback)
}

var player = new Player();

d3.csvParse(data, function(d) {
    fetchCard(d.name, function(card) {
        if ('Zombie' == card.name) {
            zombie = new Card(card);
        }
        for (var i=0; i<parseInt(d.count); i++) {
            player.zones.library.create(card);
        }
    });
});













$('#takeTurn').on('click', function(e) {
    player.takeTurn();
});

$('#addZombie').on('click', function(e) {
    player.resolveSpell(zombie);
});


        </script>

    </body>
</html>
